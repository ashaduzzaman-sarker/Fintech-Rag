version: '3.8'

services:
  # ============================================================================
  # FastAPI Application
  # ============================================================================
  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: fintech-rag-api
    ports:
    - 8000:8000      # API
    - 9090:9090      # Metrics
    environment:
    - ENVIRONMENT=production
    - LOG_LEVEL=INFO
    - API_HOST=0.0.0.0
    - API_PORT=8000
    env_file:
    - ../.env
    volumes:
    - ../data:/app/data
    - ../logs:/app/logs
    restart: unless-stopped
    networks:
    - rag-network
    healthcheck:
      test: [CMD, curl, -f, http://localhost:8000/api/v1/health]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================================================
  # Prometheus (Metrics Collection)
  # ============================================================================
  prometheus:
    image: prom/prometheus:latest
    container_name: fintech-rag-prometheus
    ports:
    - 9091:9090
    volumes:
    - ../monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
    - prometheus-data:/prometheus
    command:
    - --config.file=/etc/prometheus/prometheus.yml
    - --storage.tsdb.path=/prometheus
    - --web.console.libraries=/usr/share/prometheus/console_libraries
    - --web.console.templates=/usr/share/prometheus/consoles
    restart: unless-stopped
    networks:
    - rag-network
    depends_on:
    - api

  # ============================================================================
  # Grafana (Metrics Visualization)
  # ============================================================================
  grafana:
    image: grafana/grafana:latest
    container_name: fintech-rag-grafana
    ports:
    - 3000:3000
    environment:
    - GF_SECURITY_ADMIN_PASSWORD=admin
    - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
    - grafana-data:/var/lib/grafana
    - ../monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
    restart: unless-stopped
    networks:
    - rag-network
    depends_on:
    - prometheus

networks:
  rag-network:
    driver: bridge

volumes:
  prometheus-data:
  grafana-data:
